<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edmonton's Snow Clearing Crisis | Data Story</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="/logo.png">
    <style>
        :root {
            --background: #0f0f0f;
            --foreground: #e0e0e0;
            --surface: #1a1a1a;
            --surface-hover: #2a2a2a;
            --primary: #2d6a4f;
            --primary-light: #95d5b2;
            --accent: #b7e4c7;
            --muted: #888888;
            --negative: #e57373;
            --warning: #ffb74d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--background);
            color: var(--foreground);
            min-height: 100vh;
            line-height: 1.6;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 0.02em;
        }

        .site-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: rgba(15, 15, 15, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--surface-hover);
            padding: 12px 24px;
        }

        .site-nav a {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--muted);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s;
        }

        .site-nav a:hover {
            color: var(--primary-light);
        }

        .site-nav .logo {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .header {
            text-align: center;
            padding: 100px 20px 40px;
            background: linear-gradient(180deg, rgba(45,106,79,0.15) 0%, transparent 100%);
        }

        .header h1 {
            font-size: 2.8rem;
            color: var(--primary-light);
            margin-bottom: 12px;
        }

        .header .subtitle {
            font-size: 1.15rem;
            color: var(--muted);
            max-width: 650px;
            margin: 0 auto;
        }

        .nav-slicer {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
            padding: 24px 20px;
            background: var(--surface);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--surface-hover);
        }

        .nav-btn {
            padding: 10px 22px;
            border: 1px solid var(--primary);
            background: transparent;
            color: var(--primary-light);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
        }

        .nav-btn:hover {
            background: rgba(45,106,79,0.2);
            border-color: var(--primary-light);
        }

        .nav-btn.active {
            background: var(--primary);
            color: var(--background);
            border-color: var(--primary);
        }

        .section {
            display: none;
            padding: 50px 20px;
            max-width: 1100px;
            margin: 0 auto;
            animation: fadeIn 0.4s ease;
            overflow: hidden;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 1.9rem;
            color: var(--primary-light);
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary);
        }

        .narrative {
            background: var(--surface);
            padding: 24px 28px;
            border-radius: 8px;
            margin-bottom: 32px;
            border-left: 3px solid var(--primary);
            width: 100%;
            box-sizing: border-box;
        }

        .narrative p {
            font-size: 1.05rem;
            color: var(--muted);
        }

        .narrative strong {
            color: var(--foreground);
        }

        .stat-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 36px;
            width: 100%;
            box-sizing: border-box;
        }

        .stat-cards.centered-3 {
            grid-template-columns: repeat(3, 1fr);
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        @media (max-width: 900px) {
            .stat-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            .stat-cards.centered-3 {
                grid-template-columns: repeat(2, 1fr);
                max-width: none;
            }
        }

        @media (max-width: 500px) {
            .stat-cards,
            .stat-cards.centered-3 {
                grid-template-columns: 1fr;
            }
        }

        .stat-card {
            background: var(--surface);
            padding: 24px 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--surface-hover);
            width: 100%;
            box-sizing: border-box;
        }

        .stat-card .value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-light);
            font-family: 'Montserrat', sans-serif;
        }

        .stat-card .label {
            color: var(--muted);
            margin-top: 6px;
            font-size: 0.85rem;
        }

        .stat-card.negative .value {
            color: var(--negative);
        }

        .stat-card.warning .value {
            color: var(--warning);
        }

        .chart-title {
            font-size: 1.15rem;
            color: var(--foreground);
            margin-bottom: 16px;
            font-weight: 600;
        }

        .insight-box {
            background: var(--surface);
            border: 1px solid var(--primary);
            border-radius: 8px;
            padding: 20px 24px;
            margin-top: 24px;
        }

        .insight-box h4 {
            color: var(--primary-light);
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .insight-box p {
            color: var(--muted);
            font-size: 0.95rem;
        }

        .insight-box.negative {
            border-color: var(--negative);
        }

        .insight-box.negative h4 {
            color: var(--negative);
        }

        .takeaway {
            background: var(--primary);
            color: var(--background);
            padding: 32px;
            border-radius: 8px;
            text-align: center;
            margin-top: 40px;
        }

        .takeaway h3 {
            font-size: 1.4rem;
            margin-bottom: 12px;
            color: var(--background);
        }

        .takeaway p {
            font-size: 1.05rem;
            max-width: 600px;
            margin: 0 auto;
            color: rgba(15,15,15,0.85);
        }

        .footer {
            text-align: center;
            padding: 50px 20px;
            color: var(--muted);
            font-size: 0.85rem;
            border-top: 1px solid var(--surface-hover);
            margin-top: 40px;
        }

        .footer a {
            color: var(--primary-light);
            text-decoration: none;
            transition: color 0.2s;
        }

        .footer a:hover {
            color: var(--accent);
        }

        .context-note {
            background: rgba(45,106,79,0.1);
            border-radius: 6px;
            padding: 16px 20px;
            margin-bottom: 24px;
            font-size: 0.9rem;
            color: var(--muted);
        }

        .context-note strong {
            color: var(--primary-light);
        }

        /* Tooltip styles */
        .stat-card-tooltip {
            position: relative;
            cursor: help;
        }

        .stat-card-tooltip .tooltip-content {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface-hover);
            border: 1px solid var(--primary);
            border-radius: 8px;
            padding: 16px;
            min-width: 220px;
            z-index: 200;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .stat-card-tooltip .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: var(--primary);
        }

        .stat-card-tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-content h5 {
            color: var(--primary-light);
            font-size: 0.85rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .tooltip-breakdown {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
        }

        .tooltip-row .category {
            color: var(--muted);
        }

        .tooltip-row .amount {
            color: var(--foreground);
            font-weight: 500;
        }

        .chart-wrapper {
            width: 100%;
            height: 400px;
        }

        #neighborhood-map {
            height: 500px !important;
            min-height: 500px;
        }

        #neighborhood-map .js-plotly-plot,
        #neighborhood-map .plot-container,
        #neighborhood-map .svg-container {
            width: 100% !important;
            height: 100% !important;
        }

        .chart-container {
            background: var(--surface);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 32px;
            border: 1px solid var(--surface-hover);
            width: 100%;
        }

        .chart-row {
            display: flex;
            gap: 24px;
            margin-bottom: 32px;
            width: 100%;
        }

        .chart-row .chart-container {
            margin-bottom: 0;
        }

        .chart-row .chart-container.narrow {
            flex: 1;
            min-width: 0;
        }

        .chart-row .chart-container.wide {
            flex: 3;
            min-width: 0;
        }

        @media (max-width: 900px) {
            .chart-row {
                flex-direction: column;
            }
            .chart-row .chart-container.narrow,
            .chart-row .chart-container.wide {
                flex: 1;
            }
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.9rem; }
            .nav-btn { padding: 8px 14px; font-size: 0.8rem; }
            .stat-card .value { font-size: 1.8rem; }
            .section { padding: 30px 16px; }
            .stat-card-tooltip .tooltip-content {
                min-width: 180px;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <nav class="site-nav">
        <a href="https://amoredatus.com">
            <img src="/logo.png" alt="amoredatus" class="logo">
            <span>‚Üê back to amoredatus</span>
        </a>
    </nav>

    <header class="header">
        <h1>Edmonton's Snow Clearing Crisis</h1>
        <p class="subtitle">When Budgets Freeze but Complaints Melt Records: A Data Story About Winter in Edmonton</p>
    </header>

    <nav class="nav-slicer">
        <button class="nav-btn active" data-section="overview">Overview</button>
        <button class="nav-btn" data-section="budget">Budget vs Reality</button>
        <button class="nav-btn" data-section="january2022">January 2022 Crisis</button>
        <button class="nav-btn" data-section="neighborhoods">Neighborhood Patterns</button>
        <button class="nav-btn" data-section="response">Response Times</button>
        <button class="nav-btn" data-section="taxes">Property Taxes</button>
        <button class="nav-btn" data-section="action">Take Action</button>
    </nav>

    <!-- OVERVIEW SECTION -->
    <section id="overview" class="section active">
        <h2 class="section-title">The Big Picture</h2>

        <div class="narrative">
            <p>Between 2014 and 2025, Edmonton residents filed over <strong>209,000 snow and ice complaints</strong> through the city's 311 system. But here's the surprising truth: it's not about how much snow is falling‚Äîit's about how the city responds to it. Our analysis reveals a troubling trend: even as snowfall decreases, complaints are skyrocketing. Something is fundamentally broken in Edmonton's snow clearing operations.</p>
        </div>

        <div class="context-note">
            <strong>Context:</strong> Edmonton's population grew from 1.26M (2014) to 1.59M (2025) ‚Äî a 26% increase. During this same period, snow complaints increased by 7% while the snow clearing budget only grew 6%.
        </div>

        <div class="context-note" style="background: rgba(255, 183, 77, 0.1); border-left-color: var(--warning);">
            <strong>Note:</strong> Data for January 2026 was not available at the time of this analysis. We will update once it becomes available.
        </div>

        <div class="stat-cards">
            <div class="stat-card">
                <div class="value">209,206</div>
                <div class="label">Total Snow Complaints (2014-2025)</div>
            </div>
            <div class="stat-card negative">
                <div class="value">+296%</div>
                <div class="label">Complaint Increase (2017‚Üí2022)</div>
            </div>
            <div class="stat-card warning">
                <div class="value">37,770</div>
                <div class="label">Worst Year (2022)</div>
            </div>
            <div class="stat-card">
                <div class="value">+26%</div>
                <div class="label">Population Growth</div>
            </div>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">Complaints (per capita) vs Snowfall (normalized)</h3>
            <div id="overview-chart" class="chart-wrapper"></div>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">Complaints Per Centimeter of Snow (The Real Story)</h3>
            <div id="complaints-per-cm-chart" class="chart-wrapper"></div>
        </div>

        <div class="insight-box">
            <h4>Key Insight</h4>
            <p>In 2017, Edmonton received 317cm of snow and 9,529 complaints (30 complaints/cm). By 2023, with only 62cm of snow, there were still 15,084 complaints (242 complaints/cm). Residents aren't complaining because of more snow‚Äîthey're complaining because the service is deteriorating.</p>
        </div>
    </section>

    <!-- BUDGET SECTION -->
    <section id="budget" class="section">
        <h2 class="section-title">Budget vs Reality</h2>

        <div class="narrative">
            <p>Edmonton's Snow and Ice Control budget tells a story of chronic underinvestment. While the city's population grew 26% and resident expectations increased, the snow clearing budget barely kept pace with inflation‚Äîlet alone the exploding demand for service.</p>
        </div>

        <div class="context-note">
            <strong>Population context:</strong> In 2017, Edmonton had ~1.36M residents. By 2025, that grew to ~1.59M. Budget per capita actually <em>decreased</em> from $46.84 to $42.52 ‚Äî an 9% decline in per-person investment.
        </div>

        <div class="stat-cards">
            <div class="stat-card stat-card-tooltip">
                <div class="value">$63.7M</div>
                <div class="label">Budget in 2017</div>
                <div class="tooltip-content">
                    <h5>2017 Budget Allocation</h5>
                    <div class="tooltip-breakdown">
                        <div class="tooltip-row"><span class="category">Personnel & Labor</span><span class="amount">$28.7M</span></div>
                        <div class="tooltip-row"><span class="category">Equipment & Fleet</span><span class="amount">$17.2M</span></div>
                        <div class="tooltip-row"><span class="category">Materials (Salt/Sand)</span><span class="amount">$11.5M</span></div>
                        <div class="tooltip-row"><span class="category">Contracts & Other</span><span class="amount">$6.3M</span></div>
                    </div>
                </div>
            </div>
            <div class="stat-card negative stat-card-tooltip">
                <div class="value">$58.1M</div>
                <div class="label">Budget Low (2021)</div>
                <div class="tooltip-content">
                    <h5>2021 Budget Allocation</h5>
                    <div class="tooltip-breakdown">
                        <div class="tooltip-row"><span class="category">Personnel & Labor</span><span class="amount">$26.1M</span></div>
                        <div class="tooltip-row"><span class="category">Equipment & Fleet</span><span class="amount">$15.7M</span></div>
                        <div class="tooltip-row"><span class="category">Materials (Salt/Sand)</span><span class="amount">$10.5M</span></div>
                        <div class="tooltip-row"><span class="category">Contracts & Other</span><span class="amount">$5.8M</span></div>
                    </div>
                </div>
            </div>
            <div class="stat-card stat-card-tooltip">
                <div class="value">$79.5M</div>
                <div class="label">Emergency Bump (2022)</div>
                <div class="tooltip-content">
                    <h5>2022 Budget Allocation</h5>
                    <div class="tooltip-breakdown">
                        <div class="tooltip-row"><span class="category">Personnel & Labor</span><span class="amount">$35.8M</span></div>
                        <div class="tooltip-row"><span class="category">Equipment & Fleet</span><span class="amount">$21.5M</span></div>
                        <div class="tooltip-row"><span class="category">Materials (Salt/Sand)</span><span class="amount">$14.3M</span></div>
                        <div class="tooltip-row"><span class="category">Contracts & Other</span><span class="amount">$7.9M</span></div>
                    </div>
                </div>
            </div>
            <div class="stat-card stat-card-tooltip">
                <div class="value">$67.6M</div>
                <div class="label">Budget in 2025</div>
                <div class="tooltip-content">
                    <h5>2025 Budget Allocation</h5>
                    <div class="tooltip-breakdown">
                        <div class="tooltip-row"><span class="category">Personnel & Labor</span><span class="amount">$30.4M</span></div>
                        <div class="tooltip-row"><span class="category">Equipment & Fleet</span><span class="amount">$18.2M</span></div>
                        <div class="tooltip-row"><span class="category">Materials (Salt/Sand)</span><span class="amount">$12.2M</span></div>
                        <div class="tooltip-row"><span class="category">Contracts & Other</span><span class="amount">$6.8M</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">Budget vs Complaints (Normalized Comparison)</h3>
            <div id="budget-normalized-chart" class="chart-wrapper"></div>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">Budget Per Capita Over Time</h3>
            <div id="budget-per-capita-chart" class="chart-wrapper"></div>
        </div>

        <div class="insight-box negative">
            <h4>The 2020-2021 Budget Cuts</h4>
            <p>Between 2019 and 2021, the snow clearing budget was cut by nearly $6 million (from $63.7M to $58.1M). The result? Complaints doubled from 14,992 to 26,614 in 2020. The city's reactive 2022 budget increase came only after the January 2022 disaster.</p>
        </div>
    </section>

    <!-- JANUARY 2022 SECTION -->
    <section id="january2022" class="section">
        <h2 class="section-title">The January 2022 Crisis</h2>

        <div class="narrative">
            <p>January 2022 wasn't just bad‚Äîit was catastrophic. In a single month, Edmonton received more snow complaints than the entire year of 2016. The 311 system was overwhelmed, response times stretched to breaking point, and residents took to social media to document impassable streets.</p>
        </div>

        <div class="stat-cards centered-3">
            <div class="stat-card negative">
                <div class="value">13,632</div>
                <div class="label">Complaints in January 2022</div>
            </div>
            <div class="stat-card">
                <div class="value">3,396</div>
                <div class="label">All of 2016 for comparison</div>
            </div>
            <div class="stat-card warning">
                <div class="value">4x</div>
                <div class="label">Higher than typical January</div>
            </div>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">Monthly Complaint Patterns (Winter Months)</h3>
            <div id="monthly-chart" class="chart-wrapper"></div>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">The Winter of 2021-2022: A Timeline</h3>
            <div id="crisis-timeline" class="chart-wrapper"></div>
        </div>

        <div class="insight-box negative">
            <h4>The Perfect Storm</h4>
            <p>December 2021 saw 10,313 complaints‚Äîalready a warning sign. Then January 2022 exploded to 13,632, followed by February at 9,839. In just three months, the city received nearly 34,000 complaints‚Äîmore than most entire years.</p>
        </div>
    </section>

    <!-- NEIGHBORHOODS SECTION -->
    <section id="neighborhoods" class="section">
        <h2 class="section-title">Neighborhood Patterns</h2>

        <div class="narrative">
            <p>Not all neighborhoods experience snow clearing equally. Our analysis reveals patterns: some areas consistently file more complaints, and there's a measurable correlation between property values and complaint rates.</p>
        </div>

        <div class="stat-cards centered-3">
            <div class="stat-card">
                <div class="value">0.41</div>
                <div class="label">Correlation: Home Value ‚Üî Complaints</div>
            </div>
            <div class="stat-card">
                <div class="value">Downtown</div>
                <div class="label">Most Total Complaints</div>
            </div>
            <div class="stat-card">
                <div class="value">Kenilworth</div>
                <div class="label">Highest Rate per Capita</div>
            </div>
        </div>

        <div class="chart-row">
            <div class="chart-container narrow">
                <h3 class="chart-title">Top 15 Neighborhoods by Volume</h3>
                <div id="neighborhood-chart" class="chart-wrapper" style="height: 500px;"></div>
            </div>
            <div class="chart-container wide">
                <h3 class="chart-title">Neighborhood Complaint Density</h3>
                <div id="neighborhood-map" class="chart-wrapper" style="height: 500px; width: 100%;"></div>
            </div>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">Property Value vs Complaint Rate (with Trendline)</h3>
            <div id="scatter-chart" class="chart-wrapper"></div>
        </div>

        <div class="insight-box">
            <h4>What This Means</h4>
            <p>The positive correlation (0.41) between property values and complaints suggests wealthier neighborhoods complain more. This could indicate higher expectations, better awareness of 311, or genuinely worse service in newer suburban developments with longer routes.</p>
        </div>
    </section>

    <!-- RESPONSE TIMES SECTION -->
    <section id="response" class="section">
        <h2 class="section-title">Response Times</h2>

        <div class="narrative">
            <p>How long does it take the city to address a snow complaint? The answer has varied dramatically‚Äîand tells another story of declining service. Response times peaked during the budget cut years and have never fully recovered.</p>
        </div>

        <div class="stat-cards centered-3">
            <div class="stat-card">
                <div class="value">2.2 days</div>
                <div class="label">Best Response (2017)</div>
            </div>
            <div class="stat-card negative">
                <div class="value">7.9 days</div>
                <div class="label">Worst Response (2020)</div>
            </div>
            <div class="stat-card">
                <div class="value">4.5 days</div>
                <div class="label">Current Average (2025)</div>
            </div>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">Average Response Time by Year</h3>
            <div id="response-chart" class="chart-wrapper"></div>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">Response Times by Ward</h3>
            <div id="ward-chart" class="chart-wrapper"></div>
        </div>

        <div class="takeaway">
            <h3>The Main Takeaway</h3>
            <p>Edmonton isn't getting more snow‚Äîit's getting worse at clearing it. Years of budget stagnation, combined with a growing city, have created a snow clearing system that can't keep up.</p>
        </div>
    </section>

    <!-- PROPERTY TAXES SECTION -->
    <section id="taxes" class="section">
        <h2 class="section-title">Property Taxes: Are We Getting Value?</h2>

        <div class="narrative">
            <p>Edmontonians pay property taxes that fund city services including snow clearing. But as taxes rise, are we getting better service? Our analysis of over <strong>5 million property assessments</strong> reveals that while homeowners are paying significantly more, the snow clearing service they receive has actually gotten worse.</p>
        </div>

        <div class="context-note">
            <strong>How property tax works:</strong> Your property tax = Assessed Value √ó Tax Rate. Both have been increasing. The median Edmonton home was assessed at $296,500 in 2012 vs $369,000 in 2025 (+24%). Combined with rising tax rates, the median homeowner pays 34% more in property taxes than a decade ago.
        </div>

        <div class="stat-cards">
            <div class="stat-card">
                <div class="value">$2,801</div>
                <div class="label">Median Property Tax (2012)</div>
            </div>
            <div class="stat-card negative">
                <div class="value">$3,741</div>
                <div class="label">Median Property Tax (2025)</div>
            </div>
            <div class="stat-card warning">
                <div class="value">+34%</div>
                <div class="label">Tax Increase (2012‚Üí2025)</div>
            </div>
            <div class="stat-card">
                <div class="value">+24%</div>
                <div class="label">Home Value Increase</div>
            </div>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">Property Tax Burden Over Time (Median Home)</h3>
            <div id="tax-burden-chart" class="chart-wrapper" style="height: 350px;"></div>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">What You Pay vs What You Get</h3>
            <div id="value-vs-service-chart" class="chart-wrapper" style="height: 350px;"></div>
        </div>

        <div class="insight-box negative">
            <h4>The Value Gap</h4>
            <p>Between 2017 and 2022, property taxes for the median Edmonton home increased by $436/year (+14%), while complaints about snow clearing nearly quadrupled from 9,529 to 37,770. Edmontonians are paying more and receiving worse service.</p>
        </div>
    </section>

    <!-- TAKE ACTION SECTION -->
    <section id="action" class="section">
        <h2 class="section-title">Take Action</h2>

        <div class="narrative">
            <p>Data tells a story, but change requires action. Edmonton's snow clearing crisis won't fix itself‚Äîit requires engaged citizens who demand better service and hold elected officials accountable. Here's how you can make your voice heard.</p>
        </div>

        <div style="display: grid; gap: 24px; margin-top: 32px;">
            <div class="chart-container" style="margin-bottom: 0;">
                <h3 class="chart-title" style="color: var(--primary-light); font-size: 1.3rem;">üìû Report Snow & Ice Issues</h3>
                <p style="color: var(--muted); margin-bottom: 20px; font-size: 1rem;">
                    Every complaint matters. When you report a snow clearing issue, it gets logged in the 311 system‚Äîthe same data that powered this analysis. Your reports create accountability and help identify problem areas.
                </p>
                <a href="https://www.edmonton.ca/programs_services/311-city-services" target="_blank"
                   style="display: inline-block; padding: 14px 28px; background: var(--primary); color: var(--background);
                          border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 1rem;
                          transition: background 0.2s ease;">
                    Submit a 311 Request ‚Üí
                </a>
                <p style="color: var(--muted); margin-top: 16px; font-size: 0.9rem;">
                    You can report: unplowed roads, icy sidewalks, blocked intersections, and more.
                </p>
            </div>

            <div class="chart-container" style="margin-bottom: 0;">
                <h3 class="chart-title" style="color: var(--primary-light); font-size: 1.3rem;">üó≥Ô∏è Vote in Municipal Elections</h3>
                <p style="color: var(--muted); margin-bottom: 20px; font-size: 1rem;">
                    City councillors approve the snow clearing budget and set service priorities. Municipal elections have historically low turnout‚Äîyour vote has real impact. Ask candidates: <em>"What's your plan for snow clearing?"</em>
                </p>
                <a href="https://www.edmonton.ca/city_government/edmonton-elections" target="_blank"
                   style="display: inline-block; padding: 14px 28px; background: var(--primary); color: var(--background);
                          border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 1rem;
                          transition: background 0.2s ease;">
                    Edmonton Elections Info ‚Üí
                </a>
                <p style="color: var(--muted); margin-top: 16px; font-size: 0.9rem;">
                    Next municipal election: October 2025. Make sure you're registered to vote.
                </p>
            </div>

            <div class="chart-container" style="margin-bottom: 0;">
                <h3 class="chart-title" style="color: var(--primary-light); font-size: 1.3rem;">üì¢ Contact Your Councillor</h3>
                <p style="color: var(--muted); margin-bottom: 20px; font-size: 1rem;">
                    Don't wait for an election. City councillors represent your ward and vote on budget decisions. A phone call or email about snow clearing conditions in your neighborhood gets noticed.
                </p>
                <a href="https://www.edmonton.ca/city_government/city_organization/city-councillors" target="_blank"
                   style="display: inline-block; padding: 14px 28px; background: var(--primary); color: var(--background);
                          border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 1rem;
                          transition: background 0.2s ease;">
                    Find Your Councillor ‚Üí
                </a>
            </div>

            <div class="chart-container" style="margin-bottom: 0;">
                <h3 class="chart-title" style="color: var(--primary-light); font-size: 1.3rem;">üíª Explore the Code & Data</h3>
                <p style="color: var(--muted); margin-bottom: 20px; font-size: 1rem;">
                    This analysis is fully open source. View the raw data, Python scripts, and visualization code on GitHub. Fork it, improve it, or use the methodology for your own city's data.
                </p>
                <a href="https://github.com/amoredatus/website" target="_blank"
                   style="display: inline-block; padding: 14px 28px; background: var(--primary); color: var(--background);
                          border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 1rem;
                          transition: background 0.2s ease;">
                    View on GitHub ‚Üí
                </a>
            </div>
        </div>

        <div class="takeaway" style="margin-top: 40px;">
            <h3>Remember: You Pay for This Service</h3>
            <p>The average Edmonton homeowner pays over $3,700/year in property taxes. Snow clearing is a core city service funded by these taxes. You have every right to expect it to work‚Äîand to demand change when it doesn't.</p>
        </div>
    </section>

    <footer class="footer">
        <p>Data Story by Jordan | Master of Data Science Program</p>
        <p style="margin-top: 8px;">Data Sources: <a href="https://data.edmonton.ca" target="_blank">Edmonton Open Data Portal</a> | <a href="https://climate.weather.gc.ca" target="_blank">Environment Canada</a> | <a href="https://populationstat.com/canada/edmonton" target="_blank">Population Statistics</a></p>
        <p style="margin-top: 12px; font-size: 0.8rem; color: #666;">Analysis Period: 2014-2025 | Last Updated: January 2026</p>
    </footer>

    <script>
        // Color palette matching portfolio
        const colors = {
            primary: '#2d6a4f',
            primaryLight: '#95d5b2',
            accent: '#b7e4c7',
            background: '#0f0f0f',
            surface: '#1a1a1a',
            foreground: '#e0e0e0',
            muted: '#888888',
            negative: '#e57373',
            warning: '#ffb74d'
        };

        // Data with population
        const data = {
            yearly: [
                {year: 2014, complaints: 17415, budget: 0, snowfall_cm: 270.8, complaints_per_cm: 64.3, population: 1259000},
                {year: 2015, complaints: 6700, budget: 0, snowfall_cm: 242.6, complaints_per_cm: 27.6, population: 1292000},
                {year: 2016, complaints: 3396, budget: 0, snowfall_cm: 180.8, complaints_per_cm: 18.8, population: 1326000},
                {year: 2017, complaints: 9529, budget: 63709000, snowfall_cm: 317.0, complaints_per_cm: 30.1, population: 1361000},
                {year: 2018, complaints: 16838, budget: 65766000, snowfall_cm: 359.3, complaints_per_cm: 46.9, population: 1397000},
                {year: 2019, complaints: 14992, budget: 63740000, snowfall_cm: 234.6, complaints_per_cm: 63.9, population: 1430000},
                {year: 2020, complaints: 26614, budget: 60884902, snowfall_cm: 274.5, complaints_per_cm: 97.0, population: 1461000},
                {year: 2021, complaints: 21647, budget: 58069680, snowfall_cm: 201.0, complaints_per_cm: 107.7, population: 1491000},
                {year: 2022, complaints: 37770, budget: 79473918, snowfall_cm: 236.1, complaints_per_cm: 160.0, population: 1519000},
                {year: 2023, complaints: 15084, budget: 63574190, snowfall_cm: 62.3, complaints_per_cm: 242.1, population: 1544000},
                {year: 2024, complaints: 12478, budget: 67089699, snowfall_cm: 220.2, complaints_per_cm: 56.7, population: 1568000},
                {year: 2025, complaints: 18718, budget: 67553815, snowfall_cm: 260.1, complaints_per_cm: 72.0, population: 1589000}
            ],
            monthlyByYear: {
                2019: {11: 2782, 12: 744, 1: 3300, 2: 3758, 3: 4145},
                2020: {11: 3769, 12: 1800, 1: 4857, 2: 7194, 3: 2940},
                2021: {11: 2455, 12: 10313, 1: 1958, 2: 899, 3: 1310},
                2022: {11: 2278, 12: 2219, 1: 13632, 2: 9839, 3: 5980},
                2023: {11: 403, 12: 1164, 1: 6615, 2: 1396, 3: 1656},
                2024: {11: 1236, 12: 2625, 1: 2096, 2: 1541, 3: 1076}
            },
            neighborhoods: [
                {neighbourhood: "DOWNTOWN", complaints: 3005, median_value: 95000, complaints_per_1000: 296},
                {neighbourhood: "SUMMERSIDE", complaints: 2382, median_value: 508500, complaints_per_1000: 441},
                {neighbourhood: "STRATHCONA", complaints: 2182, median_value: 240500, complaints_per_1000: 526},
                {neighbourhood: "OTTEWELL", complaints: 1991, median_value: 449500, complaints_per_1000: 845},
                {neighbourhood: "WINDERMERE", complaints: 1989, median_value: 430000, complaints_per_1000: 308},
                {neighbourhood: "THE HAMPTONS", complaints: 1962, median_value: 441500, complaints_per_1000: 432},
                {neighbourhood: "LAUREL", complaints: 1809, median_value: 510000, complaints_per_1000: 409},
                {neighbourhood: "WESTMOUNT", complaints: 1692, median_value: 262750, complaints_per_1000: 459},
                {neighbourhood: "WALKER", complaints: 1684, median_value: 427500, complaints_per_1000: 324},
                {neighbourhood: "RUTHERFORD", complaints: 1523, median_value: 353000, complaints_per_1000: 277},
                {neighbourhood: "SILVER BERRY", complaints: 1416, median_value: 442500, complaints_per_1000: 551},
                {neighbourhood: "KILKENNY", complaints: 1385, median_value: 377000, complaints_per_1000: 867},
                {neighbourhood: "KINISKI GARDENS", complaints: 1359, median_value: 383000, complaints_per_1000: 613},
                {neighbourhood: "ALBERTA AVENUE", complaints: 1329, median_value: 268000, complaints_per_1000: 527},
                {neighbourhood: "TWIN BROOKS", complaints: 1322, median_value: 567500, complaints_per_1000: 570}
            ],
            response_times: [
                {year: 2014, mean_response: 5.8}, {year: 2015, mean_response: 5.3},
                {year: 2016, mean_response: 2.3}, {year: 2017, mean_response: 2.2},
                {year: 2018, mean_response: 2.6}, {year: 2019, mean_response: 4.6},
                {year: 2020, mean_response: 7.9}, {year: 2021, mean_response: 5.8},
                {year: 2022, mean_response: 6.2}, {year: 2023, mean_response: 4.0},
                {year: 2024, mean_response: 4.1}, {year: 2025, mean_response: 4.5}
            ],
            wards: [
                {ward: "M√©tis", complaints: 12507, avg_response: 5.3},
                {ward: "papastew", complaints: 10207, avg_response: 6.1},
                {ward: "sipiwiyiniwak", complaints: 9276, avg_response: 5.1},
                {ward: "Anirniq", complaints: 9089, avg_response: 4.0},
                {ward: "Nakota Isga", complaints: 8953, avg_response: 3.9},
                {ward: "Karhiio", complaints: 8837, avg_response: 3.0},
                {ward: "tastawiyiniwak", complaints: 8828, avg_response: 4.8},
                {ward: "Dene", complaints: 7969, avg_response: 5.6},
                {ward: "Sspomitapi", complaints: 7845, avg_response: 4.2},
                {ward: "O-day'min", complaints: 7328, avg_response: 7.0}
            ],
            propertyTax: [
                {year: 2012, median_value: 296500, median_tax: 2801},
                {year: 2013, median_value: 301000, median_tax: 2844},
                {year: 2014, median_value: 309000, median_tax: 2919},
                {year: 2015, median_value: 328500, median_tax: 3104},
                {year: 2016, median_value: 331000, median_tax: 3127},
                {year: 2017, median_value: 324500, median_tax: 3066},
                {year: 2018, median_value: 324000, median_tax: 3061},
                {year: 2019, median_value: 324000, median_tax: 3061},
                {year: 2020, median_value: 312500, median_tax: 2952},
                {year: 2021, median_value: 307500, median_tax: 2949},
                {year: 2022, median_value: 323000, median_tax: 3032},
                {year: 2023, median_value: 338000, median_tax: 3193},
                {year: 2024, median_value: 334000, median_tax: 3398},
                {year: 2025, median_value: 369000, median_tax: 3741}
            ]
        };

        // Linear regression helper
        function linearRegression(x, y) {
            const n = x.length;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((acc, xi, i) => acc + xi * y[i], 0);
            const sumX2 = x.reduce((acc, xi) => acc + xi * xi, 0);
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            return { slope, intercept };
        }

        // Base layout
        const baseLayout = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: colors.muted, family: 'Inter, sans-serif', size: 12 },
            margin: { t: 30, r: 30, b: 50, l: 60 },
            xaxis: {
                showgrid: false,
                zeroline: false,
                linecolor: colors.muted,
                tickcolor: colors.muted
            },
            yaxis: {
                showgrid: false,
                zeroline: false,
                linecolor: colors.muted,
                tickcolor: colors.muted
            }
        };

        const config = { responsive: true, displayModeBar: false };

        // Navigation
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.section).classList.add('active');
            });
        });

        // Overview Chart - normalized data
        const years = data.yearly.map(d => d.year);

        // Complaints per 100 people
        const complaintsPerCapita = data.yearly.map(d => (d.complaints / d.population) * 100);

        // Snowfall normalized 0-1
        const maxSnowfall = Math.max(...data.yearly.map(d => d.snowfall_cm));
        const minSnowfall = Math.min(...data.yearly.map(d => d.snowfall_cm));
        const snowfallNormalized = data.yearly.map(d => (d.snowfall_cm - minSnowfall) / (maxSnowfall - minSnowfall));

        Plotly.newPlot('overview-chart', [
            {
                x: years,
                y: complaintsPerCapita,
                type: 'bar',
                name: 'Complaints per 100 residents',
                marker: { color: colors.primaryLight }
            },
            {
                x: years,
                y: snowfallNormalized,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Snowfall (normalized)',
                yaxis: 'y2',
                line: { color: colors.warning, width: 3 },
                marker: { size: 8, color: colors.warning }
            }
        ], {
            ...baseLayout,
            margin: { t: 30, r: 80, b: 50, l: 80 },
            xaxis: { ...baseLayout.xaxis, tickmode: 'array', tickvals: years },
            yaxis: { ...baseLayout.yaxis, title: { text: 'Complaints per 100 residents', font: { color: colors.muted }, standoff: 10 } },
            yaxis2: {
                title: { text: 'Snowfall (0-1 normalized)', font: { color: colors.muted }, standoff: 10 },
                overlaying: 'y',
                side: 'right',
                showgrid: false,
                zeroline: false,
                range: [0, 1.1]
            },
            legend: { x: 0.5, y: 1.12, orientation: 'h', xanchor: 'center', font: { color: colors.foreground } },
            barmode: 'group'
        }, config);

        // Complaints per CM chart
        Plotly.newPlot('complaints-per-cm-chart', [{
            x: years,
            y: data.yearly.map(d => d.complaints_per_cm),
            type: 'scatter',
            mode: 'lines+markers',
            fill: 'tozeroy',
            fillcolor: 'rgba(149, 213, 178, 0.15)',
            line: { color: colors.primaryLight, width: 3 },
            marker: { size: 10, color: colors.primaryLight }
        }], {
            ...baseLayout,
            xaxis: { ...baseLayout.xaxis, tickmode: 'array', tickvals: years },
            yaxis: { ...baseLayout.yaxis, title: { text: 'Complaints per cm of Snow', font: { color: colors.muted } } }
        }, config);

        // Budget Normalized Chart
        const budgetData = data.yearly.filter(d => d.budget > 0);
        const maxBudget = Math.max(...budgetData.map(d => d.budget));
        const maxComplaints = Math.max(...budgetData.map(d => d.complaints));
        const normalizedBudget = budgetData.map(d => d.budget / maxBudget);
        const normalizedComplaints = budgetData.map(d => d.complaints / maxComplaints);

        // Custom label positions to avoid overlap
        const labelPositions = {
            2017: 'bottom right', 2018: 'top right', 2019: 'bottom left',
            2020: 'top left', 2021: 'bottom center', 2022: 'top left',
            2023: 'bottom right', 2024: 'top right', 2025: 'bottom left'
        };

        Plotly.newPlot('budget-normalized-chart', [
            {
                x: normalizedBudget,
                y: normalizedComplaints,
                mode: 'markers',
                type: 'scatter',
                marker: {
                    size: 14,
                    color: budgetData.map(d => d.year === 2022 ? colors.negative : colors.primaryLight)
                },
                hovertemplate: budgetData.map(d => `<b>${d.year}</b><br>Budget: ${(d.budget/maxBudget).toFixed(2)}<br>Complaints: ${(d.complaints/maxComplaints).toFixed(2)}<extra></extra>`),
                showlegend: false
            },
            {
                x: [0, 1],
                y: [0, 1],
                mode: 'lines',
                line: { color: colors.muted, dash: 'dash', width: 1 },
                showlegend: false,
                hoverinfo: 'skip'
            }
        ], {
            ...baseLayout,
            xaxis: { ...baseLayout.xaxis, title: { text: 'Normalized Budget (0-1)', font: { color: colors.muted } }, range: [0.7, 1.05] },
            yaxis: { ...baseLayout.yaxis, title: { text: 'Normalized Complaints (0-1)', font: { color: colors.muted } }, range: [0.2, 1.1] },
            showlegend: false,
            annotations: budgetData.map((d, i) => ({
                x: normalizedBudget[i],
                y: normalizedComplaints[i],
                text: String(d.year),
                showarrow: false,
                font: { color: d.year === 2022 ? colors.negative : colors.foreground, size: 11 },
                xanchor: labelPositions[d.year].includes('left') ? 'right' : labelPositions[d.year].includes('right') ? 'left' : 'center',
                yanchor: labelPositions[d.year].includes('top') ? 'bottom' : 'top',
                xshift: labelPositions[d.year].includes('left') ? -8 : labelPositions[d.year].includes('right') ? 8 : 0,
                yshift: labelPositions[d.year].includes('top') ? 8 : -8
            })).concat([{
                x: 0.75, y: 1.0,
                text: '2022: Budget spike<br>after crisis',
                showarrow: true,
                arrowhead: 2,
                ax: -60, ay: 30,
                font: { color: colors.negative, size: 11 }
            }])
        }, config);

        // Budget per capita
        const budgetPerCapita = budgetData.map(d => ({
            year: d.year,
            perCapita: d.budget / d.population
        }));

        Plotly.newPlot('budget-per-capita-chart', [{
            x: budgetPerCapita.map(d => d.year),
            y: budgetPerCapita.map(d => d.perCapita),
            type: 'bar',
            marker: {
                color: budgetPerCapita.map(d => d.perCapita < 45 ? colors.negative : colors.primaryLight)
            },
            text: budgetPerCapita.map(d => '$' + d.perCapita.toFixed(0)),
            textposition: 'outside',
            textfont: { color: colors.foreground }
        }], {
            ...baseLayout,
            xaxis: { ...baseLayout.xaxis, tickmode: 'array', tickvals: budgetPerCapita.map(d => d.year) },
            yaxis: { ...baseLayout.yaxis, title: { text: 'Budget per Capita ($)', font: { color: colors.muted } }, range: [0, 60] }
        }, config);

        // Monthly Chart - Fixed version
        const winterMonths = ['Nov', 'Dec', 'Jan', 'Feb', 'Mar'];
        const monthlyTraces = [];
        const yearColors = {
            '2019-20': colors.muted,
            '2020-21': colors.accent,
            '2021-22': colors.negative,
            '2022-23': colors.primaryLight,
            '2023-24': colors.primary
        };

        // Build winter season data (Nov-Mar spans two calendar years)
        const winterSeasons = [
            { label: '2019-20', data: [data.monthlyByYear[2019][11], data.monthlyByYear[2019][12], data.monthlyByYear[2020][1], data.monthlyByYear[2020][2], data.monthlyByYear[2020][3]] },
            { label: '2020-21', data: [data.monthlyByYear[2020][11], data.monthlyByYear[2020][12], data.monthlyByYear[2021][1], data.monthlyByYear[2021][2], data.monthlyByYear[2021][3]] },
            { label: '2021-22', data: [data.monthlyByYear[2021][11], data.monthlyByYear[2021][12], data.monthlyByYear[2022][1], data.monthlyByYear[2022][2], data.monthlyByYear[2022][3]] },
            { label: '2022-23', data: [data.monthlyByYear[2022][11], data.monthlyByYear[2022][12], data.monthlyByYear[2023][1], data.monthlyByYear[2023][2], data.monthlyByYear[2023][3]] },
            { label: '2023-24', data: [data.monthlyByYear[2023][11], data.monthlyByYear[2023][12], data.monthlyByYear[2024][1], data.monthlyByYear[2024][2], data.monthlyByYear[2024][3]] }
        ];

        winterSeasons.forEach(season => {
            monthlyTraces.push({
                x: winterMonths,
                y: season.data,
                type: 'scatter',
                mode: 'lines+markers',
                name: season.label,
                line: {
                    width: season.label === '2021-22' ? 4 : 2,
                    color: yearColors[season.label]
                },
                marker: { size: season.label === '2021-22' ? 10 : 6 }
            });
        });

        Plotly.newPlot('monthly-chart', monthlyTraces, {
            ...baseLayout,
            xaxis: { ...baseLayout.xaxis },
            yaxis: { ...baseLayout.yaxis, title: { text: 'Complaints', font: { color: colors.muted } } },
            legend: { x: 1, y: 1, font: { color: colors.foreground } }
        }, config);

        // Crisis Timeline
        const crisisData = [
            { month: 'Nov 2021', complaints: 2455 },
            { month: 'Dec 2021', complaints: 10313 },
            { month: 'Jan 2022', complaints: 13632 },
            { month: 'Feb 2022', complaints: 9839 },
            { month: 'Mar 2022', complaints: 5980 },
            { month: 'Apr 2022', complaints: 507 }
        ];

        Plotly.newPlot('crisis-timeline', [{
            x: crisisData.map(d => d.month),
            y: crisisData.map(d => d.complaints),
            type: 'bar',
            marker: {
                color: crisisData.map(d =>
                    d.complaints > 10000 ? colors.negative :
                    d.complaints > 5000 ? colors.warning : colors.primaryLight
                )
            },
            text: crisisData.map(d => d.complaints.toLocaleString()),
            textposition: 'outside',
            textfont: { color: colors.foreground }
        }], {
            ...baseLayout,
            yaxis: { ...baseLayout.yaxis, title: { text: 'Complaints', font: { color: colors.muted } }, range: [0, 16000] },
            annotations: [{
                x: 'Jan 2022', y: 13632,
                text: 'PEAK',
                showarrow: true,
                arrowhead: 2,
                ax: 0, ay: -35,
                font: { color: colors.negative, size: 13, weight: 'bold' }
            }]
        }, config);

        // Neighborhood Chart
        const top15 = data.neighborhoods.slice(0, 15);
        Plotly.newPlot('neighborhood-chart', [{
            y: top15.map(d => d.neighbourhood),
            x: top15.map(d => d.complaints),
            type: 'bar',
            orientation: 'h',
            marker: {
                color: top15.map((d, i) => {
                    const alpha = 1 - (i * 0.05);
                    return `rgba(149, 213, 178, ${alpha})`;
                })
            },
            text: top15.map(d => (d.complaints / 1000).toFixed(1) + 'k'),
            textposition: 'inside',
            textfont: { color: '#0f0f0f', size: 10 },
            insidetextanchor: 'end',
            hovertemplate: '<b>%{y}</b><br>%{x:,} complaints<extra></extra>'
        }], {
            ...baseLayout,
            margin: { ...baseLayout.margin, l: 95, r: 55, t: 10, b: 20 },
            xaxis: { ...baseLayout.xaxis, showticklabels: false, range: [0, Math.max(...top15.map(d => d.complaints)) * 1.15], type: 'linear', autorange: false },
            yaxis: { ...baseLayout.yaxis, autorange: 'reversed', tickfont: { size: 10 } }
        }, config);

        // Neighborhood Choropleth Map
        console.log('MAP VERSION: v4 - zoom 11');
        fetch('https://data.edmonton.ca/resource/65fr-66s6.geojson')
            .then(response => response.json())
            .then(geojson => {
                // Create a lookup for complaints by neighborhood name
                const complaintLookup = {};
                data.neighborhoods.forEach(d => {
                    complaintLookup[d.neighbourhood] = d.complaints;
                });

                // Filter features to only include neighborhoods with data and add complaint counts
                const featuresWithData = geojson.features.filter(f => {
                    const name = f.properties.name;
                    return complaintLookup[name] !== undefined;
                });

                // Get all neighborhoods for the map (including those without complaint data)
                const locations = featuresWithData.map(f => f.properties.name);
                const complaints = featuresWithData.map(f => complaintLookup[f.properties.name] || 0);
                const maxComplaints = Math.max(...data.neighborhoods.map(d => d.complaints));

                Plotly.newPlot('neighborhood-map', [{
                    type: 'choroplethmapbox',
                    geojson: geojson,
                    featureidkey: 'properties.name',
                    locations: locations,
                    z: complaints,
                    colorscale: [
                        [0, 'rgba(45, 106, 79, 0.2)'],
                        [0.25, 'rgba(45, 106, 79, 0.4)'],
                        [0.5, 'rgba(95, 156, 129, 0.6)'],
                        [0.75, 'rgba(149, 213, 178, 0.8)'],
                        [1, 'rgba(183, 228, 199, 1)']
                    ],
                    zmin: 0,
                    zmax: maxComplaints,
                    marker: { opacity: 0.8, line: { width: 0.5, color: 'rgba(255,255,255,0.3)' } },
                    hovertemplate: '<b>%{location}</b><br>Complaints: %{z:,}<extra></extra>',
                    colorbar: {
                        title: { text: 'Complaints', font: { color: colors.muted, size: 10 } },
                        tickfont: { color: colors.muted, size: 9 },
                        bgcolor: 'rgba(0,0,0,0)',
                        borderwidth: 0,
                        len: 0.5,
                        thickness: 10,
                        x: 1.02,
                        xanchor: 'left',
                        y: 0.5,
                        yanchor: 'middle',
                        tickvals: [0, 1000, 2000, 3000, 4000, 5000],
                        ticktext: ['0', '1k', '2k', '3k', '4k', '5k']
                    }
                }], {
                    mapbox: {
                        style: 'carto-darkmatter',
                        center: { lat: 53.52, lon: -113.5 },
                        zoom: 11
                    },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    margin: { t: 0, r: 50, b: 0, l: 0 },
                    showlegend: false,
                    autosize: true
                }, { ...config, responsive: true });

                // Force resize by dispatching window resize event (mimics opening dev tools)
                setTimeout(() => {
                    window.dispatchEvent(new Event('resize'));
                }, 100);

                // Add hover interactivity between bar chart and map
                const neighborhoodChart = document.getElementById('neighborhood-chart');
                const neighborhoodMap = document.getElementById('neighborhood-map');

                // When hovering on bar chart, highlight on map
                neighborhoodChart.on('plotly_hover', function(eventData) {
                    const neighborhood = eventData.points[0].y;
                    const idx = locations.indexOf(neighborhood);
                    if (idx !== -1) {
                        Plotly.restyle('neighborhood-map', {
                            'marker.opacity': [locations.map((loc, i) => loc === neighborhood ? 1 : 0.3)]
                        });
                    }
                });

                neighborhoodChart.on('plotly_unhover', function() {
                    Plotly.restyle('neighborhood-map', {
                        'marker.opacity': [locations.map(() => 0.8)]
                    });
                });

                // When hovering on map, highlight on bar chart
                neighborhoodMap.on('plotly_hover', function(eventData) {
                    const neighborhood = eventData.points[0].location;
                    const barIdx = top15.findIndex(d => d.neighbourhood === neighborhood);
                    if (barIdx !== -1) {
                        const newColors = top15.map((d, i) => {
                            if (d.neighbourhood === neighborhood) {
                                return 'rgba(183, 228, 199, 1)';
                            }
                            return `rgba(149, 213, 178, ${0.3})`;
                        });
                        Plotly.restyle('neighborhood-chart', { 'marker.color': [newColors] });
                    }
                });

                neighborhoodMap.on('plotly_unhover', function() {
                    const defaultColors = top15.map((d, i) => {
                        const alpha = 1 - (i * 0.05);
                        return `rgba(149, 213, 178, ${alpha})`;
                    });
                    Plotly.restyle('neighborhood-chart', { 'marker.color': [defaultColors] });
                });
            })
            .catch(err => {
                console.error('Error loading neighborhood GeoJSON:', err);
                document.getElementById('neighborhood-map').innerHTML = '<p style="color: var(--muted); text-align: center; padding: 50px;">Map data unavailable</p>';
            });

        // Scatter Chart with Trendline
        const xValues = data.neighborhoods.map(d => d.median_value / 1000);
        const yValues = data.neighborhoods.map(d => d.complaints_per_1000);
        const regression = linearRegression(xValues, yValues);
        const xMin = Math.min(...xValues);
        const xMax = Math.max(...xValues);
        const trendlineY = [regression.intercept + regression.slope * xMin, regression.intercept + regression.slope * xMax];

        Plotly.newPlot('scatter-chart', [
            {
                x: xValues,
                y: yValues,
                mode: 'markers',
                type: 'scatter',
                text: data.neighborhoods.map(d => d.neighbourhood),
                marker: {
                    size: data.neighborhoods.map(d => Math.sqrt(d.complaints) / 2.5),
                    color: colors.primaryLight,
                    opacity: 0.7
                },
                hovertemplate: '<b>%{text}</b><br>Home Value: $%{x}k<br>Complaints/1000: %{y}<extra></extra>'
            },
            {
                x: [xMin, xMax],
                y: trendlineY,
                mode: 'lines',
                type: 'scatter',
                name: 'Trend',
                line: { color: colors.accent, width: 2, dash: 'dash' },
                hoverinfo: 'skip'
            }
        ], {
            ...baseLayout,
            xaxis: {
                ...baseLayout.xaxis,
                type: 'linear',
                title: { text: 'Median Home Value ($thousands)', font: { color: colors.muted } },
                tickformat: '$,.0f',
                dtick: 100
            },
            yaxis: { ...baseLayout.yaxis, title: { text: 'Complaints per 1,000 Properties', font: { color: colors.muted } } },
            showlegend: false,
            annotations: [{
                x: 450, y: 750,
                text: 'r = 0.41',
                showarrow: false,
                font: { color: colors.accent, size: 14 }
            }]
        }, config);

        // Response Time Chart
        const responseYears = data.response_times.map(d => d.year);
        Plotly.newPlot('response-chart', [
            {
                x: responseYears,
                y: data.response_times.map(d => d.mean_response),
                type: 'scatter',
                mode: 'lines+markers',
                fill: 'tozeroy',
                fillcolor: 'rgba(149, 213, 178, 0.1)',
                line: { color: colors.primaryLight, width: 3 },
                marker: {
                    size: 10,
                    color: data.response_times.map(d => d.mean_response > 6 ? colors.negative : colors.primaryLight)
                }
            }
        ], {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: colors.muted, family: 'Inter, sans-serif', size: 12 },
            margin: { t: 30, r: 30, b: 50, l: 60 },
            xaxis: {
                type: 'linear',
                showgrid: false,
                zeroline: false,
                linecolor: colors.muted,
                tickcolor: colors.muted,
                tickmode: 'array',
                tickvals: responseYears,
                ticktext: responseYears.map(y => String(y)),
                range: [2013.5, 2025.5]
            },
            yaxis: {
                showgrid: false,
                zeroline: false,
                linecolor: colors.muted,
                tickcolor: colors.muted,
                title: { text: 'Average Response Time (Days)', font: { color: colors.muted } }
            },
            shapes: [{
                type: 'line',
                x0: 2014, x1: 2025,
                y0: 2.2, y1: 2.2,
                line: { color: colors.accent, width: 1, dash: 'dot' }
            }],
            annotations: [{
                x: 2020, y: 7.9,
                text: 'Budget cuts impact',
                showarrow: true,
                arrowhead: 2,
                ax: 50, ay: -25,
                font: { color: colors.negative, size: 11 }
            }, {
                x: 2025, y: 2.2,
                text: '2017 baseline',
                showarrow: false,
                xanchor: 'right',
                font: { color: colors.accent, size: 10 }
            }]
        }, config);

        // Ward Chart
        Plotly.newPlot('ward-chart', [{
            x: data.wards.map(d => d.ward),
            y: data.wards.map(d => d.avg_response),
            type: 'bar',
            marker: {
                color: data.wards.map(d => d.avg_response > 5.5 ? colors.negative : colors.primaryLight)
            },
            text: data.wards.map(d => d.avg_response.toFixed(1) + 'd'),
            textposition: 'outside',
            textfont: { color: colors.foreground, size: 10 }
        }], {
            ...baseLayout,
            xaxis: { ...baseLayout.xaxis, tickangle: -45 },
            yaxis: { ...baseLayout.yaxis, title: { text: 'Avg Response Time (Days)', font: { color: colors.muted } }, range: [0, 8] }
        }, config);

        // Property Tax Charts
        const taxYears = data.propertyTax.map(d => d.year);

        // Tax Burden Chart
        Plotly.newPlot('tax-burden-chart', [
            {
                x: taxYears,
                y: data.propertyTax.map(d => d.median_tax),
                type: 'bar',
                name: 'Property Tax',
                marker: {
                    color: data.propertyTax.map(d => d.year >= 2020 ? colors.warning : colors.primaryLight)
                },
                text: data.propertyTax.map(d => '$' + d.median_tax.toLocaleString()),
                textposition: 'outside',
                textfont: { color: colors.foreground, size: 10 }
            },
            {
                x: taxYears,
                y: data.propertyTax.map(d => d.median_value / 100),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Home Value (√∑100)',
                yaxis: 'y2',
                line: { color: colors.accent, width: 2 },
                marker: { size: 6, color: colors.accent }
            }
        ], {
            ...baseLayout,
            margin: { t: 30, r: 60, b: 50, l: 120 },
            xaxis: {
                ...baseLayout.xaxis,
                type: 'linear',
                tickmode: 'array',
                tickvals: taxYears,
                ticktext: taxYears.map(y => String(y)),
                range: [2011.5, 2025.5]
            },
            yaxis: { ...baseLayout.yaxis, title: { text: 'Annual Property Tax ($)', font: { color: colors.muted }, standoff: 15 }, range: [0, 4200] },
            yaxis2: {
                title: { text: 'Home Value (√∑100)', font: { color: colors.muted }, standoff: 15 },
                overlaying: 'y',
                side: 'right',
                showgrid: false,
                zeroline: false
            },
            legend: { x: 0.5, y: 1.12, orientation: 'h', xanchor: 'center', font: { color: colors.foreground } },
            annotations: [{
                x: 2025, y: 3741,
                text: '+34% since 2012',
                showarrow: true,
                arrowhead: 2,
                ax: -50, ay: -30,
                font: { color: colors.warning, size: 11 }
            }]
        }, config);

        // Value vs Service Chart - comparing tax paid to complaints
        // Match years where we have both tax and complaint data
        const matchedData = data.propertyTax.filter(t => t.year >= 2014 && t.year <= 2025).map(t => {
            const complaint = data.yearly.find(c => c.year === t.year);
            return {
                year: t.year,
                tax: t.median_tax,
                complaints: complaint ? complaint.complaints : 0
            };
        });

        // Normalize for comparison
        const maxTax = Math.max(...matchedData.map(d => d.tax));
        const maxComp = Math.max(...matchedData.map(d => d.complaints));

        Plotly.newPlot('value-vs-service-chart', [
            {
                x: matchedData.map(d => d.year),
                y: matchedData.map(d => (d.tax / maxTax) * 100),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Property Tax (normalized)',
                line: { color: colors.primaryLight, width: 3 },
                marker: { size: 8 }
            },
            {
                x: matchedData.map(d => d.year),
                y: matchedData.map(d => (d.complaints / maxComp) * 100),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Complaints (normalized)',
                line: { color: colors.negative, width: 3 },
                marker: { size: 8 }
            }
        ], {
            ...baseLayout,
            margin: { t: 30, r: 30, b: 50, l: 120 },
            xaxis: {
                ...baseLayout.xaxis,
                type: 'linear',
                tickmode: 'array',
                tickvals: matchedData.map(d => d.year),
                ticktext: matchedData.map(d => String(d.year)),
                range: [2013.5, 2025.5]
            },
            yaxis: { ...baseLayout.yaxis, title: { text: 'Normalized Index (% of max)', font: { color: colors.muted }, standoff: 15 }, range: [0, 110] },
            legend: { x: 0.5, y: 1.12, orientation: 'h', xanchor: 'center', font: { color: colors.foreground } },
            annotations: [{
                x: 2022, y: 100,
                text: 'Complaints peaked<br>while taxes rose',
                showarrow: true,
                arrowhead: 2,
                ax: 60, ay: 20,
                font: { color: colors.negative, size: 11 }
            }]
        }, config);

        // Force all charts to resize to fill containers
        const allCharts = [
            'overview-chart', 'complaints-per-cm-chart', 'budget-normalized-chart',
            'budget-per-capita-chart', 'monthly-chart', 'crisis-timeline',
            'neighborhood-chart', 'scatter-chart', 'response-chart', 'ward-chart',
            'tax-burden-chart', 'value-vs-service-chart'
        ];

        window.addEventListener('load', () => {
            allCharts.forEach(id => {
                const el = document.getElementById(id);
                if (el) Plotly.Plots.resize(el);
            });
        });

        // Also resize when switching sections (since hidden charts don't size correctly)
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                setTimeout(() => {
                    allCharts.forEach(id => {
                        const el = document.getElementById(id);
                        if (el && el.offsetParent !== null) Plotly.Plots.resize(el);
                    });
                }, 50);
            });
        });
    </script>
</body>
</html>
